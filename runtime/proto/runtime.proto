syntax = "proto3";

package apeiron.runtime.v1;

service RuntimeService {
    rpc SubmitJob(SubmitJobRequest) returns (SubmitJobResponse);
    rpc GetJobStatus(GetJobStatusRequest) returns (GetJobStatusResponse);
    rpc CancelJob(CancelJobRequest) returns (CancelJobResponse);
    rpc GetCertificate(GetCertificateRequest) returns (GetCertificateResponse);
}

message SubmitJobRequest {
    string job_id = 1;
    JobSpec job_spec = 2;
}

message SubmitJobResponse {
    string job_id = 1;
    JobStatus status = 2;
}

message GetJobStatusRequest {
    string job_id = 1;
}

message GetJobStatusResponse {
    string job_id = 1;
    JobStatus status = 2;
    JobMetrics metrics = 3;
}

message CancelJobRequest {
    string job_id = 1;
}

message CancelJobResponse {
    bool success = 1;
}

message GetCertificateRequest {
    string job_id = 1;
}

message GetCertificateResponse {
    Certificate certificate = 1;
}

message JobSpec {
    string initial_state_ref = 1;
    repeated OperatorRef operators = 2;
    EvolutionParams evolution_params = 3;
}

message OperatorRef {
    string name = 1;
    string artifact_path = 2;
}

message EvolutionParams {
    double time_step = 1;
    uint64 max_steps = 2;
    double tolerance = 3;
}

message JobStatus {
    enum Status {
        UNKNOWN = 0;
        PENDING = 1;
        RUNNING = 2;
        COMPLETED = 3;
        FAILED = 4;
    }
    Status status = 1;
    string message = 2;
}

message JobMetrics {
    double cpu_usage = 1;
    uint64 memory_usage = 2;
    repeated GpuUsage gpu_usage = 3;
    uint64 execution_time_ms = 4;
}

message GpuUsage {
    uint32 gpu_id = 1;
    double utilization = 2;
    uint64 memory_used = 3;
    uint64 memory_total = 4;
}

message Certificate {
    string job_id = 1;
    CertificateData data = 2;
    Proof proof = 3;
}

message CertificateData {
    StateSnapshot final_state = 1;
    TopologySignature topology_signature = 2;
    StabilityProof stability_proof = 3;
}

message StateSnapshot {
    double time = 1;
    bytes state_data = 2;
}

message TopologySignature {
    repeated uint32 betti_numbers = 1;
    repeated HomologyGenerator generators = 2;
}

message HomologyGenerator {
    uint32 dimension = 1;
    string representation = 2;
}

message StabilityProof {
    bool convergence = 1;
    bool stability = 2;
    bytes proof_data = 3;
}

message Proof {
    string proof_type = 1;
    bytes proof_data = 2;
}

